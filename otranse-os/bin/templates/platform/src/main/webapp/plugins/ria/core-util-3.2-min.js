Ext.namespace("Disco.Ext.Util");(function(){Ext.apply(Disco.Ext.Util,{NormalClass:{},theStatus:[["\u542f\u7528",0],["\u505c\u7528",-1]],readOnlyGridCellColor:"#F2F2F2",successTag:"<font color=green>&#8730;</font>",failureTag:"<font color=red>X</font>",linkRenderer:function(v){if(!v){return""}else{return String.format("<a style=\"color:blue;font-weight:800;\" title=\"\u70b9\u51fb\u540e\u5c06\u5728\u65b0\u7a97\u53e3\u4e2d\u6253\u5f00{0}\" href='{0}' target='_blank'>{0}</a>",v)}},booleanRender:function(value,p,record){return value?'<span style="color:green;">\u662f</span>':'<span style="color:red;">\u5426</span>'},dateRender:function(format){format=format||"Y-m-d H:i:s";return Ext.util.Format.dateRenderer(format)},imgRender:function(v){if(!v){return""}else{return String.format("<a style=\"color:green;font-weight:800\" title=\"\u70b9\u51fb\u540e\u5c06\u5728\u65b0\u7a97\u53e3\u4e2d\u6253\u5f00{0}\" href='{0}' target='_blank'>\u67e5\u770b</a>",v)}},moneyRender:function(v){if(v){if(v.toFixed){if(v<0){return"<font color=red>"+v.toFixed(2)+"<font>"}else{return v.toFixed(2)}}else{return v}}},objectRender:function(p,backgroundColor){return function(v,meta){if(backgroundColor){meta.attr='style="background-color:'+backgroundColor+';"'}var s="";try{s=v?eval("v."+p):""}catch(e){}return s}},comboxRender:function(v){if(v){return v.text||v.title||v}},typesRender:function(types){return function(v){for(var i=0;i<types.length;i++){try{if(types[i][1]===v){return types[i][0]}}catch(e){alert(types)}}return""}},readOnlyRender:function(innerRender){return function(v,meta){var d=v;if(innerRender){d=innerRender(d)}meta.attr='style="background-color:'+Disco.Ext.Util.readOnlyGridCellColor+';"';return d}},operaterTemplate:new Ext.Template("<a href='javascript:;' theid='{2}' op='{1}' onclick='return false'><font color='blue'>{0}</font></a>"),operaterRender:function(cmd,title){return function(v,p,r){if(r.get("id")){return Disco.Ext.Util.operaterTemplate.applyTemplate([title?title:(v?v:""),cmd,r.get("id")])}}},autoCloseMsg:function(){Ext.Msg.hide()},executeUrl:function(url,params,fn){return function(){Ext.Ajax.request({waitMsg:"\u6b63\u5728\u6267\u884c\u64cd\u4f5c\uff0c\u8bf7\u7a0d\u5019...",url:url,method:"POST",params:params,success:function(response){var r=Ext.decode(response.responseText);if(!r.success){Disco_RIA.ajaxErrorHandler(r)}else{Ext.Msg.alert("\u63d0\u793a","\u64cd\u4f5c\u6210\u529f",fn?fn:Ext.emptyFn,this)}},scope:this})}},executeQuietlyUrl:function(url,params,fn){return function(){Ext.Ajax.request({url:url,method:"POST",params:params,success:function(resp){var r=Ext.decode(resp.responseText);fn?fn(r):Ext.emptyFn},scope:this})}},submitForm:function(form,url,callback,scope,failure){form.submit({url:url,waitTitle:"\u8bf7\u7a0d\u5019",waitMsg:"\u6b63\u5728\u4fdd\u5b58\uff0c\u8bf7\u7a0d\u5019",success:function(form,action){if(callback){callback.call(scope||this,form,action)}},failure:function(form,action){if(failure){failure.call(scope||this,form,action)}else{var msg="";if(action.failureType==Ext.form.Action.SERVER_INVALID){if(form.notAlert){return""}for(var p in action.result.errors){msg+=action.result.errors[p]+"  "}}if(!msg){var s="";if(action&&action.response&&!action.result){var data=Ext.decode(action.response.responseText);if(data){var s=data.err||data.error}}msg=s||"\u6570\u636e\u5f55\u5165\u4e0d\u5408\u6cd5\u6216\u4e0d\u5b8c\u6574\uff01"}Disco.Ext.Msg.error(msg,"\u4fdd\u5b58\u5931\u8d25\uff01")}},scope:scope||this})},getEditGridData:function(editGrid,prefix,key,filter){function getV(v){if(v&&v.value!==undefined){v=v.value}else{if(v&&v.id!==undefined){v=v.id}}if(v&&typeof v=="object"&&v.clearTime){v=v.format("Y-m-d")}return v}var o={};var mc=editGrid.getColumnModel().getColumnCount();for(var i=0;i<mc;i++){var n=editGrid.getColumnModel().getDataIndex(i);if(n){o[(prefix?prefix:"")+n]=[]}}var store=editGrid.store;var j=0;var numbererField=editGrid.getColumnModel().getColumnById("numberer")?editGrid.getColumnModel().getColumnById("numberer").dataIndex:"";for(var i=0;i<store.getCount();i++){if(key){var v=store.getAt(i).get(key);v=getV(v);if(!v){continue}if(filter&&!filter(store.getAt(i))){continue}if(typeof v=="object"&&!String(v)){continue}}for(var n in o){var f=prefix?n.replace(prefix,""):n;if(f==numbererField){o[n][j]=j}else{var v=store.getAt(i).get(f);v=getV(v);o[n][j]=(v!==null?v:"")}}j++}return j>0?o:{}},getGridDataAsString:function(grid,key){var s=[],key=key||"id";grid.store.each(function(r){s.push(r.get(key))});return s.join(",")},appendGridRows:function(grid,storeMapping,rs,dataHandler,keepLastEmptyRow){if(rs.length==undefined){rs=[rs]}var selectRow=grid.getSelectionModel().getSelectedCell?grid.getSelectionModel().getSelectedCell():null;var lastSecondRow=grid.store.getCount()-(keepLastEmptyRow?2:1);var appendTo=lastSecondRow;if(selectRow){appendTo=selectRow[0]}if(appendTo<-1){appendTo=-1}if(appendTo==lastSecondRow+1){appendTo=lastSecondRow}for(var i=0;i<rs.length;i++){var r=rs[i];var obj=dataHandler(r);Disco.Ext.Util.addGridRow(grid,storeMapping,obj,appendTo+i)}},addEditorGridRow:function(grid,storeMapping,obj,appendTo){var row=appendTo;if(row==undefined){var selModel=grid.getSelectionModel();var record=selModel.getSelectedCell?selModel.getSelectedCell():null;row=grid.store.getCount()-1;if(record){row=record[0]}}var create=Ext.data.Record.create(storeMapping);var obj=new create(Ext.apply({},obj||{}));if(grid.stopEditing){grid.stopEditing()}grid.store.insert(row+1,obj);grid.getView().refresh()},removeEditorGridRow:function(grid,callback){var record=grid.getSelectionModel().getSelectedCell();if(record){var store=grid.store;Ext.MessageBox.confirm("\u8bf7\u786e\u8ba4","\u786e\u5b9a\u8981\u5220\u9664\u5417\uff1f",function(ret){if(ret=="yes"){var r=store.getAt(record[0]);if(callback){callback(r)}store.remove(r);grid.getView().refresh();if(store.getCount()>0){grid.getSelectionModel().select(record[0]-1<0?0:record[0]-1,record[1])}}})}else{Ext.MessageBox.alert("\u63d0\u793a","\u8bf7\u9009\u62e9\u8981\u5220\u9664\u7684\u8bb0\u5f55!")}},reloadGrid:function(grid){grid.getStore().removeAll();grid.getStore().reload()},removeGridRows:function(grid,callback){if(!grid.getSelectionModel().getSelections&&grid.getSelectionModel().getSelectedCell){Disco.Ext.Util.removeEditorGridRow(grid,callback)}else{var rs=grid.getSelectionModel().getSelections();if(rs&&rs.length>0){var store=grid.store;Ext.MessageBox.confirm("\u8bf7\u786e\u8ba4","\u786e\u5b9a\u8981\u5220\u9664\u5417\uff1f",function(ret){if(ret=="yes"){if(callback){callback(rs)}for(var i=0;i<rs.length;i++){store.remove(rs[i])}grid.getView().refresh()}})}}},setGridColumnHidden:function(fields,hidden,grid){if(grid!=null&&fields!=null&&fields.length){for(var i=0;i<fields.length;i++){var index=grid.getColumnModel().findColumnIndex(fields[i]);if(index>=0){grid.getColumnModel().config[index].hideable=!hidden;grid.getColumnModel().setHidden(index,hidden)}}}},buildColumnForm:function(auto,arg){var cw,defaultType="textfield",args=Array.prototype.slice.call(arguments,0);if(Ext.isBoolean(auto)||Ext.isNumber(auto)){args.shift();if(Ext.isBoolean(auto)&&auto){var arr=args[0]||args[1];if(!Ext.isArray(arr)){arr=args}cw=(1/arr.length).toFixed(5)}else{if(Ext.isNumber(auto)){if(auto>1){if(auto<50){cw=(1/auto).toFixed(5)}else{cw=auto}}else{cw=auto}}else{cw=0.5}}}else{cw=0.5}if(Ext.isString(args[0])){defaultType=args.shift()}if(Ext.isArray(args[0])){args=args.shift()}var config={items:[],anchor:"100%",layout:"column",xtype:"container"};Ext.each(args,function(field){var item={items:field,anchor:"100%",layout:"form",border:false,xtype:"container",defaultType:defaultType,defaults:{anchor:"-20"}};if(cw<50){item.columnWidth=cw}else{item.width=cw}if(field.panelCfg){Ext.apply(item,field.panelCfg);delete field.panelCfg}config.items.push(item)});return config},buildJsonStore:function(url,fields,autoLoad,root,totalProperty){return new Ext.data.JsonStore({url:url,fields:fields,autoLoad:autoLoad,root:root||"result",totalProperty:totalProperty||"rowCount"})},oneColumnPanelBuild:function(){var agrugments=arguments;Disco.Ext.Util.buildColumnForm.apply(true,agrugments)},columnPanelBuild:function(){var args=Array.prototype.slice.call(arguments,0);var formConfig={};if(args[0]){if(args[0].FC||args[0].formConfig){Ext.apply(formConfig,(args[0].FC||args[0].formConfig));args.shift()}}var obj={layout:"column",anchor:"100%",defaults:{border:false},items:[],xtype:"panel",border:false,bodyBorder:false};var defaultColumn=(1/args.length).toFixed(2);for(var i=0;i<args.length;i++){var o=args[i];var c={columnWidth:o.columnWidth||defaultColumn,layout:"form",defaultType:o.defaultType||"textfield",defaults:o.defaults||{anchor:"-20"},items:o.items};obj.items[i]=Ext.apply(c,formConfig)}return obj},columnBuild:function(){Disco.Ext.Util.twoColumnPanelBuild.apply(this,arguments)},twoColumnPanelBuild:function(){var args=Array.prototype.slice.call(arguments,0);var formConfig={};var obj={layout:"column",anchor:"100%",defaults:{border:false},items:[],xtype:"panel",border:false,bodyBorder:false};var max=2;if(typeof args[0]=="number"){max=args[0];args.shift()}if(args[0]){if(args[0].FC||args[0].formConfig){Ext.apply(formConfig,(args[0].FC||args[0].formConfig));args.shift()}}var cs=[];for(var i=0;i<max;i++){cs[i]=Ext.apply({columnWidth:1/max,layout:"form",defaultType:"textfield",defaults:{anchor:"-20"},items:[]},formConfig)}for(var i=0;i<args.length;){for(var j=0;j<max;j++,i++){cs[j].items[cs[j].items.length]=(i<args.length?args[i]:{xtype:"panel",border:false})}}obj.items=cs;return obj},TRANS_ID:0,load:function(appName){var transId=++Disco.Ext.Util.TRANS_ID;var head=document.getElementsByTagName("head")[0];var script=document.createElement("script");script.setAttribute("src",appName);script.setAttribute("type","text/javascript");script.setAttribute("id","discoScript_"+Disco.Ext.Util.TRANS_ID);head.appendChild(script)},loadJSON2Collection:function(varName,url,callback,shareCache,collectionType){Ext.Ajax.request({url:url,success:function(req){try{var ret=Ext.decode(req.responseText);var collection=shareCache||eval("new "+(collectionType||"Ext.util.MixedCollection")+"()");if(Ext.type(ret)=="array"){collection.addAll(ret);Disco.Ext.CachedRemoteObject.DATAS[varName]=collection}else{if(Ext.type(ret)=="object"&&Ext.type(ret.result)=="array"){collection.addAll(ret.result);Disco.Ext.CachedRemoteObject.DATAS[varName]=collection}}}catch(e){}if(callback){callback()}},scope:this})},loadJSONObject:function(varName,script,callback){Ext.Ajax.request({url:script,success:function(req){var ret=Ext.decode(req.responseText);if(varName){eval("("+varName+"=ret)")}if(callback){callback()}},scope:this})},loadScript:function(className,script,callback,scope,async){if(!window[className]){Ext.Ajax.request({url:script,success:function(req){window.eval(req.responseText);if(callback){callback.call(scope||window,window[className])}},scope:this,async:async})}else{if(callback){callback.call(scope||window,window[className])}}},loadClass:function(cfg,async){cfg=cfg||{};if(!Ext.isBoolean(cfg)&&Ext.isBoolean(async)){cfg.async=async}if(cfg.script){if(Ext.isEmpty(cfg.className)){var scriptUrl=cfg.script;var ji=scriptUrl.indexOf(".js");if(ji>=0){var scriptClassSub=scriptUrl.substring(0,ji);var lastIndex=scriptClassSub.lastIndexOf("/");if(lastIndex>=0){cfg.className=scriptUrl.substring(lastIndex+1,ji)}}}Ejf.Util.loadScript(cfg.className,cfg.script,cfg.callback,cfg.scope,cfg.async)}},asLoadScript:function(script,async){Ext.Ajax.request({url:script,async:async,success:function(req){eval(req.responseText)},scope:this})},loadJS:function(script){document.write("<script src='"+script+"'><\/script>")},addObject:function(crudClass,callback,script,otherScripts,winReadyAction){if(this.NormalClass[crudClass]){var clz=this.NormalClass[crudClass];var o=new clz();o.createObject(callback,winReadyAction)}else{var loadSuccess=function(req){eval(req.responseText);eval("this.NormalClass."+crudClass+"="+crudClass);var clz=this.NormalClass[crudClass];var o=new clz();o.createObject(callback,winReadyAction)};if(otherScripts){var s=otherScripts.split(";");var total=s.length,ld=0;for(var i=0;i<s.length;i++){Ext.Ajax.request({url:s[i],success:function(req){eval(req.responseText);ld++;if(ld>=total){Ext.Ajax.request({url:Disco_RIA.script+script,success:loadSuccess,scope:this})}},scope:this})}}else{Ext.Ajax.request({url:Disco_RIA.script+script,success:loadSuccess,scope:this})}}},listObject:function(crudClass,callback,script,otherScripts){if(this.NormalClass[crudClass]){var clz=this.NormalClass[crudClass];var o=new clz();if(o.list&&(typeof o.list=="function")){o=o.list()}if(callback){callback(o)}}else{if(otherScripts){var s=otherScripts.split(";");for(var i=0;i<s.length;i++){Ext.Ajax.request({url:s[i],success:function(req){eval(req.responseText)}})}}Ext.Ajax.request({url:"extApp.java?cmd=loadScript&script="+script,success:function(req){eval(req.responseText);eval("this.NormalClass."+crudClass+"="+crudClass);var clz=this.NormalClass[crudClass];var o=new clz();if(o.list&&(typeof o.list=="function")){o=o.list()}if(callback){callback(o)}},scope:this})}},editObject:function(crudClass,callback,script,otherScripts,id,winReadyAction){if(this.NormalClass[crudClass]){var clz=this.NormalClass[crudClass];var o=new clz();o.editObject(id,callback,winReadyAction)}else{if(otherScripts){var s=otherScripts.split(";");for(var i=0;i<s.length;i++){Ext.Ajax.request({url:s[i],success:function(req){eval(req.responseText)}})}}Ext.Ajax.request({url:Disco_RIA.script+script,success:function(req){eval(req.responseText);eval("this.NormalClass."+crudClass+"="+crudClass);var clz=this.NormalClass[crudClass];var o=new clz();o.editObject(id,callback,winReadyAction)},scope:this})}},viewObject:function(crudClass,callback,script,otherScripts,id){if(this.NormalClass[crudClass]){var clz=this.NormalClass[crudClass];var o=new clz();o.viewObject(id,callback)}else{if(otherScripts){var s=otherScripts.split(";");for(var i=0;i<s.length;i++){Ext.Ajax.request({url:s[i],success:function(req){eval(req.responseText)}})}}Ext.Ajax.request({url:Disco_RIA.script+script,success:function(req){eval(req.responseText);eval("this.NormalClass."+crudClass+"="+crudClass);var clz=this.NormalClass[crudClass];var o=new clz();o.viewObject(id,callback)},scope:this})}},removeObject:function(crudClass,callback,script,otherScripts,id){if(this.NormalClass[crudClass]){var clz=this.NormalClass[crudClass];var o=new clz();o.removeObject(id,callback)}else{if(otherScripts){var s=otherScripts.split(";");for(var i=0;i<s.length;i++){Ext.Ajax.request({url:s[i],success:function(req){eval(req.responseText)}})}}Ext.Ajax.request({url:Disco_RIA.script+script,success:function(req){eval(req.responseText);eval("this.NormalClass."+crudClass+"="+crudClass);var clz=this.NormalClass[crudClass];var o=new clz();o.removeObject(id,callback)},scope:this})}},buildCombox:function(name,fieldLabel,data,defaultValue,allowBlank){var cfg={};if(Ext.isObject(name)){cfg=name;data=cfg.data;delete cfg.data}else{if(Ext.isArray(name)){data=name;name=null}else{cfg={name:name,hiddenName:name,fieldLabel:fieldLabel,value:defaultValue,allowBlank:allowBlank}}}var comboCfg=Ext.apply({xtype:"combo",displayField:"title",valueField:"value",store:new Ext.data.SimpleStore({fields:["title","value"],data:data}),editable:false,mode:"local",triggerAction:"all",emptyText:"\u8bf7\u9009\u62e9..."},cfg);return comboCfg},buildRemoteCombox:function(name,fl,url,fs,df,vf,ab,lsv){var comboConfig={xtype:"smartcombo",lazyRender:true,triggerAction:"all",typeAhead:true,editable:false};if(arguments.length==1&&Ext.isObject(name)){fields=name.fields;url=name.url||name.dataUrl;Ext.del(name,"fields","url","dataUrl");Ext.apply(comboConfig,name)}else{Ext.apply(comboConfig,{name:name,hiddenName:name,allowBlank:ab,fieldLabel:fl,displayField:df?df:"title",valueField:vf?vf:"id"})}var storeConfig={id:"id",url:url,root:"result",totalProperty:"rowCount",remoteSort:true,baseParams:{pageSize:"-1"},pageSize:"-1",fields:fs};if(!Ext.isString(lsv)){comboConfig.store=new Ext.data.JsonStore(storeConfig)}else{comboConfig.store=new Disco.Ext.CachedRemoteStore(Ext.apply({varName:lsv},storeConfig))}return comboConfig},printGrid:function(grid){var win=window.open("");win.document.write("<link rel='stylesheet' type='text/css' href='/stylesheet/print.css' />");win.document.write(grid.el.dom.innerHTML);win.document.close()},getSelectWin:function(winName,title,width,height,gridClz,config){if(!Disco.Ext.SelectWin){Disco.Ext.SelectWin={}}if(!Disco.Ext.SelectWin[winName]){config=config||{};var glist=config.grid;if(!glist&&gridClz){glist=new gridClz(config)}config=Ext.apply({},{title:title,width:width,height:height,grid:glist},config);Disco.Ext.SelectWin[winName]=new Disco.Ext.GridSelectWin(config)}return Disco.Ext.SelectWin[winName]},setDelayEditorContent:function(name,html){if(typeof FCKeditorAPI=="object"){var editor=FCKeditorAPI.GetInstance(name);if(editor){editor.SetHTML(html||"")}}},setFCKEditorContent:function(name,html){if(typeof FCKeditorAPI=="object"){var editor=FCKeditorAPI.GetInstance(name);if(editor){editor.SetHTML(html||"")}else{this.setDelayEditorContent.createCallback(name,html).defer(2000)}}else{this.setDelayEditorContent.createCallback(name,html).defer(2000)}},getFckById:function(id){var fckApi=window.FCKeditorAPI;if(!fckApi){return null}return fckApi.GetInstance(id)},getFCKEditorContent:function(name){if(typeof FCKeditorAPI=="object"){var editor=FCKeditorAPI.GetInstance(name);return editor.GetHTML()}else{return""}},autoFocusFirstRow:function(grid){grid.store.on("load",function(){if(grid.rendered){var sel=grid.getSelectionModel();if(!sel.hasSelection()&&grid.store.getCount()){grid.getView().focusRow(0)}else{if(sel.hasSelection()){grid.getView().focusRow(grid.store.indexOf(grid.getSelectionModel().getSelected()))}else{grid.focus()}}}else{grid.on("render",function(g){Disco.Ext.Util.autoFocusFirstRow(g)})}})},getExportForm:function(){var exportForm=Ext.getCmp("global_export_form");if(!exportForm){exportForm=new Ext.form.FormPanel({fileUpload:true,hidden:true,items:{}});var fe=document.createElement("div");document.body.appendChild(fe);exportForm.render(fe)}return exportForm},executePanelButtons:function(p,btn,scope){if(p.getFooterToolbar()){var bt=p.getFooterToolbar().get(btn);if(bt&&!(bt.disabled||bt.hidden)&&bt.handler){bt.handler.call(scope||bt.scope||window)}}},ajaxRequest:function(url,params,scope,success,failure,successOp){Ext.Ajax.request({url:url,params:params||{},scope:scope||this,success:success||function(response,options){var data=Ext.decode(response.responseText);if(data.success){if(successOp){successOp.call(this,data,options)}else{if(data.msg){Disco.Ext.Msg.alert(data.msg)}}}else{if(data.msg){Ext.Msg.errorMsg(null,data.msg)}}},failure:failure||function(response){var data=Ext.decode(response.responseText);Ext.Msg.errorMsg(null,data.msg?data.msg:(data.errors&&data.errors.msg?data.errors.msg:"\u672a\u77e5\u9519\u8bef\u539f\u56e0!"))}})},applySkin:function(value){Ext.util.CSS.swapStyleSheet("extSkin",String.format("plugins/extjs/{0}/resources/css/{1}.css",Disco_RIA.extVersion,value));if(Disco_RIA.sysSkinPath){Ext.util.CSS.swapStyleSheet("sysSkin",Disco_RIA.sysSkinPath+value+".css")}}});Disco.Ext.Util.easycolumn=Disco.Ext.Util.buildColumnForm}());
