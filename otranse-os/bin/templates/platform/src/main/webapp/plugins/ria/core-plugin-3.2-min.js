Ext.ns("Disco.Ext","Disco.Ext.Tree");Disco.Ext.GridPanelPlugin=Ext.extend(Ext.util.Observable,{init:function(b){this.grid=b;this.store=this.grid.store;this.grid.on("render",this.initEvents,this)},beforePage:function(h){var e=this.pageToolbar.getPageData();var g=e.activePage;var f=e.pages;switch(h){case"next":if(g===f){return false}break;case"prev":if(g==1){return false}break}},initEvents:function(){this.keyMap=this.grid.getKeyMap();this.pageToolbar=this.grid.getBottomToolbar();if(this.pageToolbar){this.keyMap.addBinding([{key:Ext.EventObject.RIGHT,fn:this.pageToolbar.onClick.createInterceptor(this.beforePage,this).createDelegate(this.pageToolbar,["next"]),shift:true,scope:this},{key:Ext.EventObject.LEFT,fn:this.pageToolbar.onClick.createInterceptor(this.beforePage,this).createDelegate(this.pageToolbar,["prev"]),shift:true,scope:this}])}new Ext.KeyMap(this.grid.getGridEl(),[{key:Ext.EventObject.A,stopEvent:true,ctrl:true,fn:function(d,c){this.grid.getSelectionModel().selectAll()},scope:this},{key:Ext.EventObject.X,stopEvent:true,ctrl:true,fn:function(){this.grid.getSelectionModel().clearSelections()},scope:this}])}});Disco.Ext.HelpIconPlugin=Ext.extend(Ext.util.Observable,{init:function(a){Ext.apply(a,{onRender:a.onRender.createSequence(function(d,b){if(this.fieldLabel&&this.helpText){var c=this.el.findParent(".x-form-element",5,true)||this.el.findParent(".x-form-field-wrap",5,true);this.helpIcon=c.createChild({cls:(this.helpIconCls||"ux-helpicon-icon"),style:"width:16px; height:18px; position:absolute; left:0; top:0; display:block; background:transparent no-repeat scroll 0 2px;"});this.alignHelpIcon=function(){var e=this.wrap?this.wrap:this.el;this.helpIcon.alignTo(e,"tl-tr",[2,0])};if(this.alignErrorIcon){this.alignErrorIcon=function(){this.errorIcon.alignTo(this.helpIcon,"tl-tr",[2,0])}}this.on("resize",this.alignHelpIcon,this);Ext.QuickTips.register({target:this.helpIcon,title:(this.helpTitle||""),text:(this.helpText||"No help defined yet!"),enabled:true})}})})}});Disco.Ext.TabHistoryPlugin=Ext.extend(Object,{onTabChange:function(b,a){b.focus();this.history.push(a.id)},onTabBeforedestroy:function(a){Ext.del(this,"history","tabpanel");a.un("beforedestroy",this.onTabBeforedestroy,this)},onTabRender:function(){var b=this.tabpanel;var a=b.getKeyMap();b.getEl().setStyle("outline","0 none");b.getEl().dom.setAttribute("tabindex",0);a.addBinding([{scope:this,key:Ext.EventObject.BACKSPACE,fn:function(c,d){d.stopPropagation();this.onBack()}},{scope:this,key:Ext.EventObject.TAB,fn:function(f,i){var c=b.getActiveTab();var d=b.items,h=d.getCount(),g=0;if(c){g=d.indexOf(c);if(++g==h){g=0}}if(h){b.setActiveTab(g)}}}])},onBack:function(){var d=this.tabpanel;var c;if(this.history.length){var a=d.getActiveTab();if(this.history.length==1){return}this.history.pop();while(c=this.history.pop()){var b=d.getItem(c);if(b){d.setActiveTab(b);break}}}},init:function(a){this.tabpanel=a;this.history=[];a.on("tabchange",this.onTabChange,this);a.on("beforedestroy",this.onTabBeforedestroy,this);a.on("render",this.onTabRender,this)}});Ext.preg("tabhistoryplugin",Disco.Ext.TabHistoryPlugin);Ext.ns("Ext.ux.grid");Ext.ux.grid.GridSummary=function(a){Ext.apply(this,a)};Ext.extend(Ext.ux.grid.GridSummary,Ext.util.Observable,{init:function(b){this.grid=b;this.cm=b.getColumnModel();this.view=b.getView();var a=this.view;a.onLayout=this.onLayout;a.afterMethod("render",this.refreshSummary,this);a.afterMethod("refresh",this.refreshSummary,this);a.afterMethod("syncScroll",this.syncSummaryScroll,this);a.afterMethod("onColumnWidthUpdated",this.doWidth,this);a.afterMethod("onAllColumnWidthsUpdated",this.doAllWidths,this);a.afterMethod("onColumnHiddenUpdated",this.doHidden,this);b.store.on({add:this.refreshSummary,remove:this.refreshSummary,clear:this.refreshSummary,update:this.refreshSummary,scope:this});if(!this.rowTpl){this.rowTpl=new Ext.Template('<div class="x-grid3-summary-row x-grid3-gridsummary-row-offset">','<table class="x-grid3-summary-table" border="0" cellspacing="0" cellpadding="0" style="{tstyle}">','<tbody><tr>{cells}</tr><tr style="display:{totalDisplay}">{tcells}</tr></tbody>',"</table>","</div>");this.rowTpl.disableFormats=true}this.rowTpl.compile();if(!this.cellTpl){this.cellTpl=new Ext.Template('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} {css}" style="{style}">','<div class="x-grid3-cell-inner x-grid3-col-{id}" unselectable="on" {attr}>{value}</div>',"</td>");this.cellTpl.disableFormats=true}this.cellTpl.compile()},calculate:function(c,m,l){var e={},h=m.config;for(var f=0,k=h.length;f<k;f++){var b=h[f],g=b.dataIndex;e[g+(l?"_total":"")]=0;if(b.summaryType){for(var d=0,n=c.length;d<n;d++){var a=c[d];if(l){e[g+"_total"]=Ext.ux.grid.GridSummary.Calculations[b.summaryType](a[g],a,g+"_total",e,d)}else{e[g]=Ext.ux.grid.GridSummary.Calculations[b.summaryType](a.get(g),a,g,e,d)}}}}return e},onLayout:function(a,b){if(Ext.type(b)!="number"){return}if(!this.grid.getGridEl().hasClass("x-grid-hide-gridsummary")){this.scroller.setHeight(b-this.summary.getHeight())}},syncSummaryScroll:function(){var a=this.view.scroller.dom;this.view.summaryWrap.dom.scrollLeft=a.scrollLeft;this.view.summaryWrap.dom.scrollLeft=a.scrollLeft},doWidth:function(c,a,b){var d=this.view.summary.dom;d.firstChild.style.width=b;d.firstChild.rows[0].childNodes[c].style.width=a},doAllWidths:function(a,b){var e=this.view.summary.dom,f=a.length;e.firstChild.style.width=b;var d=e.firstChild.rows[0].childNodes;for(var c=0;c<f;c++){d[c].style.width=a[c]}},doHidden:function(b,d,a){var c=this.view.summary.dom,e=d?"none":"";c.firstChild.style.width=a;c.firstChild.rows[0].childNodes[b].style.display=e},renderSummary:function(d,h,m){h=h||this.view.getColumnData();var j=m.config,e=[],q=[],n=h.length-1;for(var f=0,g=h.length;f<g;f++){var k=h[f],b=j[f],a={};a.id=k.id;a.style=k.style;a.css=f==0?"x-grid3-cell-first ":(f==n?"x-grid3-cell-last ":"");var l=Ext.apply({},a);if(b.summaryType||b.summaryRenderer){a.value=(b.summaryRenderer||k.renderer)(d.data[k.name],a,d);l.value=(b.summaryTotalRenderer||b.summaryRenderer||k.renderer)(d.data[k.name+"_total"],a,d)}else{a.value="";l.value=""}if(a.value==undefined||a.value===""){a.value="&#160;"}if(l.value==undefined||l.value===""){l.value="&#160;"}e[e.length]=this.cellTpl.apply(a);q[q.length]=this.cellTpl.apply(l)}return this.rowTpl.apply({tstyle:"width:"+this.view.getTotalWidth()+";",cells:e.join(""),tcells:q.join(""),totalDisplay:this.grid.store.refreshCache?"display":"none"})},refreshSummary:function(){var f=this.grid,i=f.store,d=this.view.getColumnData(),a=this.cm,b=i.getRange();var h=this.calculate(b,a);if(i.refreshCache){var e=this.calculate(i.proxy.getData().getRange(),a,true);Ext.apply(h,e)}var c=this.renderSummary({data:h},d,a);if(!this.view.summaryWrap){this.view.summaryWrap=Ext.DomHelper.insertAfter(this.view.scroller,{tag:"div",cls:"x-grid3-gridsummary-row-inner"},true)}this.view.summary=this.view.summaryWrap.update(c).first()},toggleSummary:function(b){var a=this.grid.getGridEl();if(a){if(b===undefined){b=a.hasClass("x-grid-hide-gridsummary")}a[b?"removeClass":"addClass"]("x-grid-hide-gridsummary");this.view.layout()}},getSummaryNode:function(){return this.view.summary}});Ext.reg("gridsummary",Ext.ux.grid.GridSummary);Ext.ux.grid.GridSummary.Calculations={sum:function(b,a,c,e,d){return e[c]+Ext.num(b,0)},count:function(b,a,c,e,d){return d+1},max:function(b,a,c,e,d){return Math.max(Ext.num(b,0),e[c])},min:function(b,a,c,e,d){return Math.min(Ext.num(b,0),e[c])},average:function(h,c,g,b,a){var i=b[g]+Ext.num(h,0),d=c.store.getCount();try{var j=a==d-1?(i/d):i;return j}catch(f){alert(f)}},last:function(b,a,c,e,d){return b}};Ext.grid.GroupSummary=function(a){Ext.apply(this,a)};Ext.extend(Ext.grid.GroupSummary,Ext.util.Observable,{init:function(b){this.grid=b;this.cm=b.getColumnModel();this.view=b.getView();var a=this.view;a.doGroupEnd=this.doGroupEnd.createDelegate(this);a.afterMethod("onColumnWidthUpdated",this.doWidth,this);a.afterMethod("onAllColumnWidthsUpdated",this.doAllWidths,this);a.afterMethod("onColumnHiddenUpdated",this.doHidden,this);a.afterMethod("onUpdate",this.doUpdate,this);a.afterMethod("onRemove",this.doRemove,this);if(!this.rowTpl){this.rowTpl=new Ext.Template('<div class="x-grid3-summary-row" style="{tstyle}">','<table class="x-grid3-summary-table" border="0" cellspacing="0" cellpadding="0" style="{tstyle}">',"<tbody><tr>{cells}</tr></tbody>","</table></div>");this.rowTpl.disableFormats=true}this.rowTpl.compile();if(!this.cellTpl){this.cellTpl=new Ext.Template('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} {css}" style="{style}">','<div class="x-grid3-cell-inner x-grid3-col-{id}" unselectable="on">{value}</div>',"</td>");this.cellTpl.disableFormats=true}this.cellTpl.compile()},toggleSummaries:function(b){var a=this.grid.getGridEl();if(a){if(b===undefined){b=a.hasClass("x-grid-hide-summary")}a[b?"removeClass":"addClass"]("x-grid-hide-summary")}},renderSummary:function(d,h){h=h||this.view.getColumnData();var j=this.cm.config;var e=[],k,a={},b,l=h.length-1;for(var f=0,g=h.length;f<g;f++){k=h[f];b=j[f];a.id=k.id;a.style=k.style;a.css=f==0?"x-grid3-cell-first ":(f==l?"x-grid3-cell-last ":"");if(b.summaryType||b.summaryRenderer){a.value=(b.summaryRenderer||k.renderer)(d.data[k.name],a,d)}else{a.value=""}if(a.value==undefined||a.value===""){a.value="&#160;"}e[e.length]=this.cellTpl.apply(a)}return this.rowTpl.apply({tstyle:"width:"+this.view.getTotalWidth()+";",cells:e.join("")})},calculate:function(d,k){var g={},a,m,l=this.cm.config,b;for(var e=0,n=d.length;e<n;e++){a=d[e];for(var f=0,h=k.length;f<h;f++){m=k[f];b=l[f];if(b.summaryType){g[m.name]=Ext.grid.GroupSummary.Calculations[b.summaryType](g[m.name]||0,a,m.name,g)}}}return g},doGroupEnd:function(a,d,b,f,c){var e=this.calculate(d.rs,b);a.push("</div>",this.renderSummary({data:e},b),"</div>")},doWidth:function(e,b,d){var c=this.view.getGroups(),g;for(var f=0,a=c.length;f<a;f++){g=c[f].childNodes[2];g.style.width=d;g.firstChild.style.width=d;g.firstChild.rows[0].childNodes[e].style.width=b}},doAllWidths:function(g,d){var a=this.view.getGroups(),k,h,e=g.length;for(var c=0,f=a.length;c<f;c++){k=a[c].childNodes[2];k.style.width=d;k.firstChild.style.width=d;h=k.firstChild.rows[0].childNodes;for(var b=0;b<e;b++){h[b].style.width=g[b]}}},doHidden:function(d,g,c){var b=this.view.getGroups(),f,h=g?"none":"";for(var e=0,a=b.length;e<a;e++){f=b[e].childNodes[2];f.style.width=c;f.firstChild.style.width=c;f.firstChild.rows[0].childNodes[d].style.display=h}},refreshSummary:function(a){return this.refreshSummaryById(this.view.getGroupId(a))},getSummaryNode:function(a){var b=Ext.fly(a,"_gsummary");if(b){return b.down(".x-grid3-summary-row",true)}return null},refreshSummaryById:function(d){var f=document.getElementById(d);if(!f){return false}var b=[];this.grid.store.each(function(g){if(g._groupId==d){b[b.length]=g}});var c=this.view.getColumnData();var h=this.calculate(b,c);var a=this.renderSummary({data:h},c);var e=this.getSummaryNode(d);if(e){f.removeChild(e)}Ext.DomHelper.append(f,a);return true},doUpdate:function(b,a){this.refreshSummaryById(a._groupId)},doRemove:function(d,a,b,c){if(!c){this.refreshSummaryById(a._groupId)}},showSummaryMsg:function(a,d){var b=this.view.getGroupId(a);var c=this.getSummaryNode(b);if(c){c.innerHTML='<div class="x-grid3-summary-msg">'+d+"</div>"}}});Ext.grid.GroupSummary.Calculations={sum:function(b,a,c){return b+(a.data[c]||0)},count:function(b,a,d,c){return c[d+"count"]?++c[d+"count"]:(c[d+"count"]=1)},max:function(c,b,e,d){var c=b.data[e];var a=d[e+"max"]===undefined?(d[e+"max"]=c):d[e+"max"];return c>a?(d[e+"max"]=c):a},min:function(b,a,e,d){var b=a.data[e];var c=d[e+"min"]===undefined?(d[e+"min"]=b):d[e+"min"];return b<c?(d[e+"min"]=b):c},average:function(b,a,f,e){var g=e[f+"count"]?++e[f+"count"]:(e[f+"count"]=1);var d=(e[f+"total"]=((e[f+"total"]||0)+(a.data[f]||0)));return d===0?0:d/g},last:function(b,a,d,c){return b}};Ext.grid.HybridSummary=Ext.extend(Ext.grid.GroupSummary,{calculate:function(b,d){var a=this.view.getGroupField();var c=b[0].data[a];var e=this.getSummaryData(c);return e||Ext.grid.HybridSummary.superclass.calculate.call(this,b,d)},updateSummaryData:function(a,d,c){var b=this.grid.store.reader.jsonData;if(!b.summaryData){b.summaryData={}}b.summaryData[a]=d;if(!c){this.refreshSummary(a)}},getSummaryData:function(a){var b=this.grid.store.reader.jsonData;if(b&&b.summaryData){return b.summaryData[a]}return null}});Ext.ns("Disco.Ext.Tree");Disco.Ext.Tree.LocalPlugin=function(a){Ext.apply(this,a);Disco.Ext.Tree.LocalPlugin.superclass.constructor.call(this,a)};Ext.extend(Disco.Ext.Tree.LocalPlugin,Ext.util.Observable,{init:function(a){this.tree=a;this.loader=this.tree.loader;this.tree.on("render",this.initEvents,this);this.tree.on("beforedestroy",this.destroyCmp,this)},destroyCmp:function(){delete this.tree;delete this.loader;var a=this.loader.shareCache;a.un("addnode",this.addUINode,this);a.un("updatenode",this.updateUINode,this);a.un("removenode",this.removeUINode,this)},initEvents:function(){var a=this.loader.shareCache;a.on("addnode",this.addUINode,this);a.on("updatenode",this.updateUINode,this);a.on("removenode",this.removeUINode,this)},addUINode:function(c,a){var b=this.getNodeById(a.id);if(b){b.leaf=false;b.appendChild(c)}},updateUINode:function(b){var a=this.getNodeById(b.id);if(a){if(Ext.type(this.loader.transferNode)=="function"){b=Ext.apply({},b);this.loader.transferNode(b)}a.setText(b.text);Ext.copyToIf(a.attributes,b,["children","cls","loader","parentNode"]);if(a.getUI() instanceof Ext.ux.tree.ColumnNodeUI){a.getUI().updateNode(b)}if(!Ext.isEmpty(b.qtip)){if(a.getUI().getTextEl().setAttributeNS){a.getUI().getTextEl().setAttributeNS("ext","qtip",b.qtip)}else{a.getUI().getTextEl().setAttribute("ext:qtip",b.qtip)}}}},removeUINode:function(b){var a=b.parentNode;if(a&&a.children.length==0){var a=this.getNodeById(a.id);if(a){a.leaf=true;a.getUI().updateExpandIcon()}}var b=this.getNodeById(b.id);if(b){b.remove()}},getNodeById:function(a){return this.tree.getNodeById(a)}});Ext.ns("Disco.Ext");Disco.Ext.TabPanelPlugin=function(a){Ext.apply(this,a);Disco.Ext.TabPanelPlugin.superclass.constructor.call(this)};Ext.extend(Disco.Ext.TabPanelPlugin,Ext.util.Observable,{init:function(a){this.tabPanel=a;this.initEvents()},initEvents:function(){this.tabPanel.on("contextmenu",this.showContextMenu,this);if(typeof(this.tabPanel.tabSize)=="number"){this.tabPanel.on("beforeadd",this.maxTabSize,this)}},maxTabSize:function(a,c,b){if(a.items.getCount()>this.tabPanel.tabSize){Ext.Msg.show({title:"\u6e29\u99a8\u63d0\u793a",msg:"\u9762\u677f\u8d85\u8fc7\u6700\u5927\u6570\uff0c\u8bf7\u5148\u5173\u95ed\uff01",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO});return false}},createTabMenu:function(){return new Ext.menu.Menu({items:[{text:"\u5173\u95ed\u5f53\u524d\u9762\u677f",id:"closaCurrentTab",handler:this.closeTab,scope:this},{text:"\u5173\u95ed\u6240\u6709\u9762\u677f",handler:this.closeAllTab,id:"closaAllTab",scope:this},{text:"\u5173\u95ed\u5176\u5b83\u9875\u7b7e",id:"closeOtherTab",handler:this.closeElsetTab,scope:this},{text:"\u5173\u95ed\u53f3\u8fb9\u9762\u677f",id:"closaRightTab",handler:this.closeRightTab,scope:this},{text:"\u5173\u95ed\u5de6\u8fb9\u9762\u677f",id:"closaLeftTab",handler:this.closeLeftTab,scope:this}]})},showContextMenu:function(a,b,c){if(!this.theMenu){this.theMenu=this.createTabMenu()}this.doAction(a,b,c);this.theMenu.currentTab=b;this.theMenu.showAt(c.getXY())},doAction:function(h,a,f){!a.closable?this.theMenu.items.get("closaCurrentTab").disable():this.theMenu.items.get("closaCurrentTab").enable();var d=true;var b=true;var k=true;h.items.each(function(e){if(e.closable){d=false}},this);var j=h.items.filter("closable",true);if(d){this.theMenu.items.get("closeOtherTab").setDisabled(true)}else{this.theMenu.items.get("closeOtherTab").setDisabled((j.getCount()==1&&j.itemAt(0)==a))}d?this.theMenu.items.get("closaAllTab").disable():this.theMenu.items.get("closaAllTab").enable();!a.closable?this.theMenu.items.get("closaCurrentTab").disable():this.theMenu.items.get("closaCurrentTab").enable();var g=h.items.indexOf(a);if(g==this.tabPanel.items.getCount()-1){this.theMenu.items.get("closaRightTab").disable()}else{this.theMenu.items.get("closaRightTab").enable()}for(var c=g;c<h.items.getCount()-1;c++){if(h.items.itemAt(c).closable){b=false}}b?this.theMenu.items.get("closaRightTab").disable():this.theMenu.items.get("closaRightTab").enable();for(var c=g-1;c>0;c--){if(h.items.itemAt(c).closable){k=false}}k?this.theMenu.items.get("closaLeftTab").disable():this.theMenu.items.get("closaLeftTab").enable()},closeAllTab:function(c,a){var b=c.parentMenu.currentTab;this.tabPanel.items.each(function(d){if(d.closable&&d!=a){this.tabPanel.remove(d)}},this)},closeTab:function(b){var a=b.parentMenu.currentTab;if(a.closable){this.tabPanel.remove(a)}},closeElsetTab:function(b){var a=b.parentMenu.currentTab;this.closeAllTab(b,a)},closeLeftTab:function(b){var a=b.parentMenu.currentTab;var c=this.tabPanel.items.indexOf(a)-1;if(c<=0){return}var d=this.tabPanel.items.getRange(1,c);Ext.each(d,function(e){if(e&&e.closable){this.tabPanel.remove(e)}},this)},closeRightTab:function(a){var c=a.parentMenu.currentTab;var b=this.tabPanel.items.getRange(this.tabPanel.items.indexOf(c)+1,this.tabPanel.items.getCount());Ext.each(b,function(d){if(!d||d==c||!d.closable){return}this.tabPanel.remove(d)},this)}});
