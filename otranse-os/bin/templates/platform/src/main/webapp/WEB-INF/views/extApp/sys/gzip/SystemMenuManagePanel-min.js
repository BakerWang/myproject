if(typeof Global==="undefined"){Global={}}if(!Global.platformMenuLoader){Global.platformMenuLoader=new Disco.Ext.MemoryTreeLoader({iconCls:"disco-tree-node-icon",varName:"Global.PLATFORM_MENU_NODES",url:"systemMenu.java?cmd=getTree&pageSize=-1&treeData=true&all=true",listeners:{beforeload:function(b,a){b.baseParams.id=(a.id.indexOf("root")<0?a.id:"");if(typeof a.attributes.checked!=="undefined"){b.baseParams.checked=false}}}})}if(!Global.systemRoleCheckLoader){Global.systemRoleCheckLoader=new Disco.Ext.MemoryTreeLoader({iconCls:"disco-tree-node-icon",varName:"Global.SYSTEM_ROLE_CHECK_NODES",url:"role.java?cmd=getTree&pageSize=-1&treeData=true&all=true&checked=false",listeners:{beforeload:function(b,a){b.baseParams.id=(a.id.indexOf("root")<0?a.id:"");if(typeof a.attributes.checked!=="undefined"){b.baseParams.checked=false}}}})}SystemMenuListPanel=Ext.extend(Disco.Ext.CrudPanel,{baseUrl:"systemMenu.java",theStatus:[["\u935a\ue21c\u6564",0],["\u934b\u6ec5\u6564",-1]],showView:false,pageSize:15,showAdd:false,importData:false,exportData:false,createForm:function(){var a=new Ext.form.FormPanel({frame:false,labelWidth:80,labelAlign:"right",layout:"fit",items:[{xtype:"tabpanel",deferredRender:false,monitorResize:true,hideBorders:true,border:false,activeTab:0,items:[{title:"\u7eef\u8364\u7cba\u947f\u6ec3\u5d1f",border:false,layout:"form",items:[{xtype:"hidden",name:"id"},{xtype:"hidden",name:"roles"},{xtype:"fieldset",title:"\u947f\u6ec3\u5d1f\u9369\u70d8\u6e70\u6dc7\u2103\u4f05",anchor:"-1",autoHeight:true,items:[Disco.Ext.Util.twoColumnPanelBuild({fieldLabel:"\u947f\u6ec3\u5d1f\u935a\u5d87\u041e",name:"title",allowBlank:false},{fieldLabel:"\u947f\u6ec3\u5d1f\u7f02\u682b\u721c",name:"sn",allowBlank:false},{xtype:"treecombo",fieldLabel:"\u9416\u60f0\u5f4d\u9357\ufffd",name:"parent",hiddenName:"parent",displayField:"title",valueField:"id",width:110,tree:new Ext.tree.TreePanel({autoScroll:true,root:new Ext.tree.AsyncTreeNode({id:"root",text:"\u93b5\ufffd\u93c8\u590e\u5f4d\u9357\ufffd",iconCls:"treeroot-icon",expanded:true,loader:Global.platformMenuLoader})})},Ext.apply({},{fieldLabel:"\u9a9e\u51b2\u5f74\u947f\u6ec3\u5d1f",name:"system",hiddenName:"system",value:false},ConfigConst.BASE.yesNo),{xtype:"numberfield",fieldLabel:"\u7490\u572d\u6564",name:"fee"},Disco.Ext.Util.buildCombox("status","\u9418\u8235\ufffd\ufffd",this.theStatus,0),{xtype:"numberfield",fieldLabel:"\u93c4\u5267\u305a\u6924\u54c4\u7c2d",name:"sequence"}),{anchor:"98%",xtype:"checktreecombo",fieldLabel:"\u7481\u5757\u68f6\u7459\u6395\u58ca",disabled:true,displayField:"title",valueField:"id",name:"theRolesId",hiddenName:"theRolesId",tree:new Ext.tree.TreePanel({autoScroll:true,root:new Ext.tree.AsyncTreeNode({id:"root",text:"\u93b5\ufffd\u93c8\u590e\ue757\u9479\ufffd",checked:false,expanded:true,iconCls:"treeroot-icon",loader:Global.systemRoleCheckLoader})})}]},{xtype:"fieldset",title:"\u7ecb\u5b2a\u7c2d\u705e\u70b4\ufffd\ufffd",anchor:"-1",autoHeight:true,items:[Disco.Ext.Util.twoColumnPanelBuild({fieldLabel:"\u6434\u65c2\u6564\u7ecb\u5b2a\u7c2d\u7eeb\ufffd",name:"appClass"},{fieldLabel:"\u93b5\ufffd\u9366\u3125\u5bd8",name:"pack"}),{xtype:"textfield",anchor:"-20",fieldLabel:"\u9474\u6c2d\u6e70\u9366\u677f\u6f43",name:"url"},{xtype:"textfield",anchor:"-20",fieldLabel:"\u6e1a\u6fca\u7986\u9474\u6c2d\u6e70\u9366\u677f\u6f43",name:"otherScripts"},{xtype:"textfield",anchor:"-20",fieldLabel:"\u9365\u70ac\u7223",name:"icon"},{xtype:"textarea",anchor:"-20",fieldLabel:"\u9359\u509b\u669f\u6dc7\u2103\u4f05",name:"params",height:40}]}]},{title:"\u9354\u71bb\u5158\u9352\u6944\u3003",cmd:"permission",layout:"fit",hideBorders:true,bbar:[{text:"\u5a23\u8bf2\u59de\u93c9\u51ae\u6aba",handler:this.addPermission,scope:this},{text:"\u9352\u72bb\u6ace\u93c9\u51ae\u6aba",handler:this.delPermission,scope:this}],items:this.createGridPanel()}]}]});return a},createGridPanel:function(){var a=new Ext.grid.CheckboxSelectionModel();this.permissionGrid=new Ext.grid.GridPanel({cm:new Ext.grid.ColumnModel([a,{header:"\u93c9\u51ae\u6aba\u935a\u5d87\u041e",dataIndex:"id",hidden:true},{header:"\u93c9\u51ae\u6aba\u935a\u5d87\u041e",dataIndex:"name"},{header:"\u7ee0\ufffd\u6d60\ufffd",dataIndex:"description"}]),sm:a,viewConfig:{forceFit:true},store:new Ext.data.JsonStore({id:"id",totalProperty:"rowCount",fields:["id","name","description"],root:"result"})});return this.permissionGrid},loadPermission:function(){var a=this.fp.form.findField("id").getValue();if(a){this.permissionGrid.getGridEl().mask("\u9354\u72ba\u6d47\u6d93\ufffd...","x-mask-loading");Ext.Ajax.request({url:"systemMenu.java?cmd=loadPermissions",params:{systemMenuId:a},success:function(b){var b=Ext.decode(b.responseText);if(b){this.permissionGrid.getStore().loadData({result:b,rowCount:b.length})}this.permissionGrid.getGridEl().unmask()},scope:this})}},delPermission:function(){var a=this.permissionGrid.getSelections();if(a.length>0){Ext.each(a,function(b){this.permissionGrid.getStore().remove(b)},this)}},addPermission:function(){if(!this.selectWin){Disco.Ext.Util.listObject("PermissionManagePanel",function(a){this.selectWin=new Ext.Window({title:"\u7487\u70fd\ufffd\u590b\u5ae8\u93c9\u51ae\u6aba",layout:"fit",modal:true,closeAction:"hide",buttonAlign:"center",width:1000,height:550,items:a,buttons:[{text:"\u6dc7\u6fc6\u74e8",handler:function(){var c=this.selectWin.getComponent(0);var b=c.grid.getSelections();if(b.length>0){Ext.each(b,function(d){if(this.permissionGrid.getStore().indexOfId(d.get("id"))<0){this.permissionGrid.getStore().add(d)}},this)}else{Ext.Msg.show({width:200,title:"\u93bf\u5d84\u7d94\u93bb\u612e\u305a",msg:"\u6d63\u72b3\u6e6d\u95ab\u5909\u8151\u6d60\u8bb3\u7d8d\u741b\ufffd!",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO});return}this.selectWin.hide()},scope:this},{text:"\u9359\u6828\u79f7",handler:function(){this.selectWin.hide()},scope:this}]});this.selectWin.show()}.createDelegate(this),"sys/PermissionManagePanel.js")}else{this.selectWin.show()}},statusRender:function(a){if(a==-1){return"<font color=red>\u934b\u6ec5\u6564</a>"}else{return"\u935a\ue21c\u6564"}},onCreate:function(){if(this.parent){this.fp.form.findField("parent").setOriginalValue(this.parent)}this.fp.getComponent(0).setActiveTab(0);if(this.permissionGrid){this.permissionGrid.getStore().removeAll()}this.fp.form.findField("theRolesId").clearValue()},onEdit:function(f){if(f){var a=this.grid.getSelectionModel().getSelected();var e={id:"",title:""};for(var c=0,b=a.get("theRoles");c<b.length;c++){e.id+=b[c].id+(c==b.length-1?"":",");e.title+=b[c].title+(c==b.length-1?"":",")}this.fp.form.findField("theRolesId").setValue(e);this.permissionGrid.getStore().removeAll();var d=a.get("permissions");if(d&&d.length>0){this.permissionGrid.getStore().loadData({rowCount:d.length,result:d})}}},reCalMenuAndRoles:function(){var a=this.grid.getSelectionModel().getSelected();if(!a){Ext.Msg.alert("\u93bb\u612e\u305a\u6dc7\u2103\u4f05","\u7487\u70fd\ufffd\u590b\u5ae8\u7455\u4f80\u5678\u93c2\u62cc\ue178\u7ee0\u6943\u6b91\u947f\u6ec3\u5d1f\u6924\u7678\u7d12");return false}else{Ext.Ajax.request({url:"securityHelper.java",params:{cmd:"reCalSystemMenu",id:a.get("id")},scope:this,success:function(b){Ext.Msg.alert("\u93bb\u612e\u305a\u6dc7\u2103\u4f05","\u7039\u5c7e\u579a\u95b2\u5d86\u67ca\u7481\uff04\u757b\u951b\ufffd")}})}},reloadTree:function(){if(this.tree){Global.platformMenuLoader.remoteObject.clearData();var b=this.tree.getSelectionModel().getSelectedNode();this.tree.root.reload()}if(this.fp){var a=this.fp.form.findField("parent");if(a&&a.tree.rendered){a.tree.root.reload()}}},save:function(c,a){this.fp.form.baseParams={};var b=Disco.Ext.Util.getGridDataAsString(this.permissionGrid);Ext.apply(this.fp.form.baseParams,{permissions:b});SystemMenuListPanel.superclass.save.call(this,c,a)},createWin:function(b,a){return this.initWin(638,480,"\u9a9e\u51b2\u5f74\u7eef\u8364\u7cba\u947f\u6ec3\u5d1f",b,a)},storeMapping:["id","sn","title","url","vrtype","roles","permissions","types","appClass","sequence","status","parent",{name:"parentId",mapping:"parent"},"otherScripts","icon","pack","theRoles","fee","system","params"],initComponent:function(){this.cm=new Ext.grid.ColumnModel([{header:"\u7f02\u6827\u5f7f",sortable:true,width:120,dataIndex:"sn"},{header:"\u935a\u5d87\u041e",sortable:true,width:100,dataIndex:"title"},{header:"\u6434\u65c2\u6564\u7ecb\u5b2a\u7c2d\u7eeb\ufffd",sortable:true,width:160,dataIndex:"appClass"},{header:"\u6769\u70b4\u5e34\u9366\u677f\u6f43",sortable:true,width:150,dataIndex:"url"},{header:"\u7eeb\u8bf2\u57c6",sortable:true,width:120,dataIndex:"types",hidden:true},{header:"\u7481\u5757\u68f6\u7459\u6395\u58ca",sortable:true,width:120,dataIndex:"roles",hidden:true},{header:"\u9416\u5241\u9a87",sortable:true,width:120,hidden:true,dataIndex:"parent",renderer:this.objectRender("title")},{header:"\u93ba\u6391\u7c2d",sortable:true,width:40,hidden:true,dataIndex:"sequence"},{header:"\u9418\u8235\ufffd\ufffd",sortable:true,width:40,dataIndex:"status",renderer:this.statusRender},{width:80,hidden:true,sortable:true,header:"\u6e1a\u6fca\u7986\u9474\u6c2d\u6e70",dataIndex:"otherScripts"}]);SystemMenuListPanel.superclass.initComponent.call(this);this.on("removeobject",this.reloadTree,this);this.on("saveobject",this.reloadTree,this)}});SystemMenuManagePanel=function(){this.list=new SystemMenuListPanel({region:"center"});this.tree=new Ext.tree.TreePanel({title:"\u947f\u6ec3\u5d1f\u93cd\ufffd",region:"west",autoScroll:true,width:200,border:false,margins:"0 2 0 0",tools:[{id:"refresh",handler:function(){this.tree.root.reload()},scope:this}],root:new Ext.tree.AsyncTreeNode({id:"root",text:"\u93b5\ufffd\u93c8\u590e\u5f4d\u9357\ufffd",iconCls:"treeroot-icon",expanded:true,loader:Global.platformMenuLoader})});this.list.tree=this.tree;this.tree.on("click",function(b,a){var c=(b.id!="root"?b.id:"");this.list.parentId=c;this.list.store.baseParams.parentId=c;if(c){this.list.parent={id:c,title:b.text}}else{this.list.parent=null}this.list.store.removeAll();this.list.store.load()},this);SystemMenuManagePanel.superclass.constructor.call(this,{id:"systemMenuManagePanel",closable:true,border:false,autoScroll:true,layout:"border",items:[this.tree,this.list]})};Ext.extend(SystemMenuManagePanel,Ext.Panel,{});
