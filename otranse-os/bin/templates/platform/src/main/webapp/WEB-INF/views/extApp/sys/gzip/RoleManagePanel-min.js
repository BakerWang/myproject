if(typeof Global==="undefined"){Global={}}if(!Global.systemRoleLoader){Global.systemRoleLoader=new Ext.tree.TreeLoader({url:"role.java?cmd=getTree&pageSize=-1&treeData=true&all=true",iconCls:"disco-tree-node-icon",listeners:{beforeload:function(b,a){b.baseParams.id=(a.id.indexOf("root")<0?a.id:"");if(typeof a.attributes.checked!=="undefined"){b.baseParams.checked=false}}}})}if(!Global.platformMenuLoader){Global.platformMenuLoader=new Disco.Ext.MemoryTreeLoader({varName:"Global.PLATFORM_MENU_NODES",url:"systemMenu.java?cmd=getTree&pageSize=-1&treeData=true&all=true",listeners:{beforeload:function(b,a){b.baseParams.id=(a.id.indexOf("root")<0?a.id:"");if(typeof a.attributes.checked!=="undefined"){b.baseParams.checked=false}}}})}if(typeof PermissionList==="undefined"){PermissionList=Ext.extend(BaseGridList,{pageSize:20,loadData:true,url:"permission.java?cmd=list",storeMapping:["id","name","description"],quickSearch:function(){this.grid.store.removeAll();this.grid.store.reload({params:{searchKey:this.btn_search.getValue(),start:0}})},initComponent:function(){var a=new Ext.grid.CheckboxSelectionModel();this.gridConfig={sm:a},this.cm=new Ext.grid.ColumnModel([a,{header:"\u93c9\u51ae\u6aba\u935a\ufffd",sortable:true,width:60,dataIndex:"name"},{header:"\u7ee0\ufffd\u6d60\ufffd",sortable:true,width:100,dataIndex:"description"}]);this.btn_search=new Ext.form.TextField({width:100});this.tbar=["\u934f\u62bd\u656d\u701b\ufffd",this.btn_search,{text:"\u93cc\u30e8\ue1d7",handler:this.quickSearch,scope:this,cls:"x-btn-text-icon",icon:"images/icon-png/search.png"}];PermissionList.superclass.initComponent.call(this)}})}RolePanel=Ext.extend(Disco.Ext.CrudPanel,{id:"rolePanel",baseUrl:"role.java",theStatus:[["\u935a\ue21c\u6564",0],["\u934b\u6ec5\u6564",-1]],pageSize:15,importData:false,exportData:false,choicePermission:function(){if(!this.selectWin){this.selectWin=new Disco.Ext.GridSelectWin({title:"\u95ab\u590b\u5ae8\u93c9\u51ae\u6aba",grid:new PermissionList()});this.selectWin.on("select",function(a){var c=[];for(var b=0;b<a.length;b++){if(this.editGrid.store.find("id",a[b].id)<0){c[c.length]=a[b]}}this.editGrid.store.loadData(c,true)},this)}this.selectWin.show()},autoCheckEditGrid:function(b){var a=[];this.editGrid.tempCheck.each(function(c){if(this.editGrid.getStore().getById(c.id)){a.push(this.editGrid.getStore().getById(c.id))}},this);(function(){this.editGrid.getSelectionModel().selectRecords(a,true)}).defer(1,this)},saveTempCheck:function(){var c=this.editGrid.getSelectionModel();if(this.editGrid.getStore().getCount()){var a=this.sysMenuTree.getSelectionModel().getSelectedNode();var b=a.text;if(a.id!="root"){if(!c.hasSelection()){a.setText(b.replace("&#8730;",""))}else{if(b.indexOf("&#8730;")<0){a.setText(b+="&#8730;")}}}}this.editGrid.store.each(function(d){if(c.isSelected(d)){this.editGrid.tempCheck.add(d.data)}else{this.editGrid.tempCheck.removeKey(d.get("id"))}},this)},createForm:function(){var b=new Ext.grid.CheckboxSelectionModel({dataIndex:"id",handleMouseDown:Ext.emptyFn,onHdMouseDown:function(f,c){if(c.className=="x-grid3-hd-checker"){f.stopEvent();var d=Ext.fly(c.parentNode);var g=d.hasClass("x-grid3-hd-checker-on");if(g){d.removeClass("x-grid3-hd-checker-on");this.clearSelections()}else{d.addClass("x-grid3-hd-checker-on");this.grid.store.each(function(h,e){if(!h.isParent){this.selectRow(e,true);return h}},this)}}},renderer:(function(o,d,j){var c=this.grid.getSelectionModel().getSelected();if(c){var h=c.get("allPermissions");var m=c.get("permissions");if(Ext.isArray(h)&&Ext.isArray(m)){var l=false;var g=false;var e=Math.min(h.length,m.length);if(e==0){e=Math.max(h.length,m.length)}for(var f=0,n=h.length,k=m.length;f<e;f++){if(f<k&&m[f].id==o){l=true}if(f<n&&h[f].id==o){g=true}if(l&&g){break}}if(!l&&g){j.isParent=true;return'<div class="x-grid3-row-checker x-item-disabled" style="background-position:-23px 2px;">&#160;</div>'}}}return'<div class="x-grid3-row-checker">&#160;</div>'}).createDelegate(this),listeners:{selectionchange:this.saveTempCheck,scope:this}});this.editGrid=new Ext.grid.GridPanel({sm:b,region:"center",viewConfig:{forceFit:true},cm:new Ext.grid.ColumnModel([b,new Ext.grid.RowNumberer({header:"\u6434\u5fd3\u5f7f",width:40}),{header:"ID",dataIndex:"id",hideable:true,hidden:true},{header:"\u93c9\u51ae\u6aba\u935a\u5d87\u041e",dataIndex:"name",width:100,renderer:(function(o,d,j){var c=this.grid.getSelectionModel().getSelected();if(c){var h=c.get("allPermissions");var m=c.get("permissions");if(Ext.isArray(h)&&Ext.isArray(m)){var l=false;var g=false;var e=Math.min(h.length,m.length);if(e==0){e=Math.max(h.length,m.length)}for(var f=0,n=h.length,k=m.length;f<e;f++){if(f<k&&m[f].id==j.get("id")){l=true}if(f<n&&h[f].id==j.get("id")){g=true}if(l&&g){break}}if(!l&&g){j.isParent=true;return"<div><span style='float:left'>"+o+"&emsp;&emsp;&emsp;</span><span style='color:#0000FF;float:right'>\u9416\u5241\u9a87\u93c9\u51ae\u6aba&emsp;&uarr;&emsp;</span></div>"}}}return o}).createDelegate(this)}]),store:new Ext.data.JsonStore({id:"id",root:"result",totalProperty:"rowCount",url:"systemMenu.java?cmd=loadPermissions",fields:["id","name","description"],listeners:{datachanged:this.autoCheckEditGrid,scope:this}})});this.editGrid.tempCheck=new Ext.util.MixedCollection();var a=new Ext.form.FormPanel({labelWidth:60,labelAlign:"right",items:[{xtype:"hidden",name:"id"},{xtype:"fieldset",title:"\u9369\u70d8\u6e70\u6dc7\u2103\u4f05",anchor:"-1",autoHeight:true,items:[Disco.Ext.Util.twoColumnPanelBuild({xtype:"textfield",fieldLabel:"\u7459\u6395\u58ca\u935a\u5d87\u041e",name:"title",width:150},{xtype:"textfield",fieldLabel:"\u7459\u6395\u58ca\u7f02\u682b\u721c",name:"name",width:150},{xtype:"treecombo",fieldLabel:"\u9416\u60f0\ue757\u9479\ufffd",name:"parent",hiddenName:"parent",displayField:"title",valueField:"id",width:150,tree:new Ext.tree.TreePanel({autoScroll:true,root:new Ext.tree.AsyncTreeNode({id:"root",text:"\u93b5\ufffd\u93c8\u590e\ue757\u9479\ufffd",icon:"images/system/root.gif",expanded:true,loader:Global.systemRoleLoader})})},Disco.Ext.Util.buildCombox("status","\u9418\u8235\ufffd\ufffd",this.theStatus,0)),{anchor:"-20",height:50,xtype:"textarea",fieldLabel:"\u7ee0\ufffd\u6d60\ufffd",allowBlank:false,name:"description"}]},{xtype:"fieldset",title:"\u93c9\u51ae\u6aba",anchor:"-1",height:275,layout:"border",items:[this.createSysMenuTree(),this.editGrid]}]});return a},statusRender:function(a){if(a==-1){return"<font color=red>\u934b\u6ec5\u6564</a>"}else{return"\u935a\ue21c\u6564"}},onCreate:function(){this.sysMenuTree.getRootNode().removeAll(true);this.editGrid.tempCheck.clear();this.editGrid.store.removeAll();this.fp.form.findField("parent").setOriginalValue(this.parent)},onEdit:function(b){this.sysMenuTree.getRootNode().select();this.sysMenuTree.getRootNode().reload();this.editGrid.tempCheck.clear();if(b){var a=this.grid.getSelectionModel().getSelected().get("permissions");this.editGrid.store.removeAll();if(a){Ext.each(a,function(c){this.editGrid.tempCheck.add(c)},this);this.editGrid.store.loadData({rowCount:a.length,result:a})}}},save:function(b,a){this.fp.form.baseParams={permissions:this.editGrid.tempCheck.keys.join(",")};RolePanel.superclass.save.call(this,b,a)},onSave:function(){this.reloadTree()},loadSystemMenu:function(a,b){if(a.attributes.id=="root"){this.editGrid.getStore().removeAll();this.editGrid.getStore().loadData({rowCount:this.editGrid.tempCheck.getCount(),result:this.editGrid.tempCheck.items})}else{this.editGrid.getStore().removeAll();this.editGrid.getStore().baseParams={systemMenuId:a.attributes.id};this.editGrid.getStore().load()}},createSysMenuTree:function(){this.sysMenuTree=new Ext.tree.TreePanel({title:"\u947f\u6ec3\u5d1f\u93cd\ufffd",region:"west",autoScroll:true,rootVisible:false,width:200,tools:[{id:"refresh",handler:function(){this.sysMenuTree.root.reload()},scope:this}],root:new Ext.tree.AsyncTreeNode({id:"root",text:"\u93b5\ufffd\u93c8\u590e\u5f4d\u9357\ufffd",icon:"images/system/root.gif",expanded:true,loader:new Ext.tree.TreeLoader({url:"role.java?cmd=getSystemMenuTree",listeners:{beforeload:function(c,a){c.baseParams={};var b=this.fp.form.findField("id").getValue();if(b){c.baseParams.roleId=b}else{return false}if(a.attributes.id!="root"){c.baseParams.id=a.attributes.id}},scope:this}})}),listeners:{click:this.loadSystemMenu,scope:this}});return this.sysMenuTree},reloadTree:function(){this.tree.getRootNode().reload()},createWin:function(b,a){return this.initWin(738,510,"\u7eef\u8364\u7cba\u7459\u6395\u58ca",b,a)},storeMapping:["id","name","title","description","allPermissions","permissions","users","status","parent"],reCalSystemRole:function(){var a=this.grid.getSelectionModel().getSelected();if(!a){Ext.Msg.alert("\u93bb\u612e\u305a\u6dc7\u2103\u4f05","\u7487\u70fd\ufffd\u590b\u5ae8\u7455\u4f80\u5678\u93c2\u62cc\ue178\u7ee0\u6943\u6b91\u7459\u6395\u58ca\u951b\ufffd");return false}else{Ext.Ajax.request({url:"securityHelper.java",params:{cmd:"reCalSystemRole",id:a.get("id")},scope:this,success:function(b){Ext.Msg.alert("\u93bb\u612e\u305a\u6dc7\u2103\u4f05","\u7039\u5c7e\u579a\u95b2\u5d86\u67ca\u7481\uff04\u757b\u951b\ufffd")}})}},initComponent:function(){this.cm=new Ext.grid.ColumnModel([{header:"\u7459\u6395\u58ca\u935a\u5d87\u041e",sortable:true,width:100,dataIndex:"title"},{header:"\u7459\u6395\u58ca\u7f02\u682b\u721c",sortable:true,width:120,dataIndex:"name"},{header:"\u9416\u60f0\ue757\u9479\ufffd",sortable:true,width:100,dataIndex:"parent",renderer:this.objectRender("title")},{header:"\u7ee0\ufffd\u6d60\ufffd",sortable:true,width:300,dataIndex:"description"},{header:"\u9418\u8235\ufffd\ufffd",sortable:true,width:80,dataIndex:"status",renderer:this.statusRender}]);this.on("removeobject",this.reloadTree,this);RolePanel.superclass.initComponent.call(this)}});RoleManagePanel=Ext.extendX(Disco.Ext.TreeCascadePanel,function(a){return{queryParam:"parentId",treeCfg:{title:"\u7459\u6395\u58ca\u93cd\ufffd",rootText:"\u93b5\ufffd\u93c8\u590e\ue757\u9479\ufffd",rootIconCls:"treeroot-icon",loader:Global.systemRoleLoader},onTreeClick:function(b){var c=(b.id!="root"?b.id:"");this.list.parentId=c;this.list.store.baseParams.parentId=c;if(c){this.list.parent={id:c,title:b.text}}else{this.list.parent=null}a.onTreeClick.apply(this,arguments)},getPanel:function(){if(!this.panel){this.panel=new RolePanel();this.list=this.panel;this.list.tree=this.tree}return this.panel}}});
